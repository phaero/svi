#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
wscript

Created by Johan Segolsson on 2012-03-09.
Copyright (c) 2012 Johan Segolsson. All rights reserved.
"""

import os

from waflib.TaskGen import feature

LINGUAS_FILE = 'LINGUAS'

def build( bld ):
	if bld.cmd == 'clean':
		_remove_linguas_file( bld )

	# Translations
	if bld.env['INTLTOOL']:
		bld(
				features = ['linguas', 'intltool_po'],
				podir = '.',
				install_path = '${LOCALEDIR}',
				appname = 'geany',
			)

def distclean(ctx):
	_remove_linguas_file( ctx )

def _remove_linguas_file( bld ):
	# remove LINGUAS file as well
	try:
		os.unlink( os.path.join( bld.path.abspath(), LINGUAS_FILE ) )
	except OSError:
		pass

@feature('linguas')
def write_linguas_file(self):
	linguas_fname = os.path.join( self.path.abspath(), LINGUAS_FILE )

	if os.path.exists(linguas_fname):
		return
	linguas = ''
	if 'LINGUAS' in self.env:
		files = self.env['LINGUAS']
		for po_filename in files.split(' '):
			if os.path.exists ('%s.po' % po_filename):
				linguas += '%s ' % po_filename
	else:
		files = os.listdir(self.path.abspath())
		files.sort()
		for filename in files:
			if filename.endswith('.po'):
				linguas += '%s ' % filename[:-3]
	file_h = open(linguas_fname, 'w')
	file_h.write('# This file is autogenerated. Do not edit.\n%s\n' % linguas)
	file_h.close()
